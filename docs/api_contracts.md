## Контракты HTTP API

Ниже приведены ключевые методы всех микросервисов. Во всех сервисах:

- **Формат ошибок** единый:
  ```json
  {
    "error_code": "STRING_CODE",
    "message": "Читаемое описание ошибки",
    "details": { "...": "произвольные детали" }
  }
  ```
- **Коды ответов** (типовые):
  - `200 OK` — успешное выполнение запроса.
  - `201 Created` — успешно создан ресурс.
  - `400 Bad Request` — ошибка валидации/бизнес‑правил.
  - `401 Unauthorized` — нет или неверный JWT токен.
  - `403 Forbidden` — недостаточно прав (например, не admin).
  - `404 Not Found` — ресурс не найден.
  - `409 Conflict` — конфликт, например, дубликат уникального поля.
  - `503 Service Unavailable` — внутренняя ошибка, но **не 500**, сервис временно недоступен.

---

## Auth-service (порт 8001)

### POST `/auth/register`

- **Описание**: регистрация нового пользователя.
- **Тело запроса**:
  ```json
  {
    "email": "user@example.com",
    "password": "string|min 6"
  }
  ```
- **Ответ 201**:
  ```json
  {
    "id": 1,
    "email": "user@example.com",
    "role": "user",
    "is_active": true,
    "created_at": "2025-01-01T12:00:00Z"
  }
  ```
- **Ошибки**:
  - `409 Conflict` — пользователь с таким email уже существует.
  - `400/422` — невалидный email/пароль.

### POST `/auth/login`

- **Описание**: аутентификация пользователя и выдача JWT access‑token.
- **Тело запроса**:
  ```json
  {
    "email": "user@example.com",
    "password": "password123"
  }
  ```
- **Ответ 200**:
  ```json
  {
    "access_token": "<JWT>",
    "token_type": "bearer"
  }
  ```
- **Ошибки**:
  - `401 Unauthorized` — неправильный email или пароль.

### GET `/auth/me`

- **Описание**: получить профиль текущего пользователя.
- **Заголовки**:
  - `Authorization: Bearer <JWT>`
- **Ответ 200**: такой же, как при `register`.
- **Ошибки**:
  - `401` — отсутствует или неверный JWT.

### GET `/health`

- **Описание**: healthcheck без авторизации.
- **Ответ 200**:
  ```json
  { "status": "ok" }
  ```

---

## Catalog-service (порт 8002)

### GET `/books`

- **Описание**: поиск и просмотр книг (публичный эндпоинт).
- **Параметры query**:
  - `query` — подстрока в названии/описании.
  - `author` — фильтр по имени автора.
  - `category` — фильтр по названию категории.
  - `page` — номер страницы (1..N).
  - `page_size` — размер страницы (1..100).
- **Ответ 200**:
  ```json
  {
    "items": [
      {
        "id": 1,
        "title": "Book title",
        "description": "Optional",
        "isbn": "1234567890",
        "price": 10.5,
        "author": { "id": 1, "name": "Author Name" },
        "categories": [{ "id": 1, "name": "Category" }],
        "stock_quantity": 5,
        "created_at": "2025-01-01T12:00:00Z"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 10
  }
  ```

### GET `/books/{id}`

- **Описание**: получить одну книгу по идентификатору (публично).
- **Ответ 200**: как один элемент из примера выше.
- **Ошибки**:
  - `404` — книга не найдена.

### POST `/books` (admin)

- **Описание**: создать новую книгу, автора, категории и запись в stock.
- **Заголовки**:
  - `Authorization: Bearer <admin-JWT>`
- **Тело запроса**:
  ```json
  {
    "title": "Book title",
    "description": "Optional",
    "isbn": "1234567890",
    "price": 10.5,
    "author_name": "Author Name",
    "category_names": ["Category 1", "Category 2"],
    "stock_quantity": 5
  }
  ```
- **Ответ 201**: объект книги с вложенными автором/категориями/stock_quantity.
- **Ошибки**:
  - `401/403` — нет токена или не admin.
  - `409` — книга с таким ISBN уже существует.

### PATCH `/books/{id}` (admin)

- **Описание**: частичное обновление книги и/или количества на складе.
- **Тело запроса** (любой поднабор полей):
  ```json
  {
    "title": "New title",
    "description": "New description",
    "price": 12.0,
    "stock_quantity": 7
  }
  ```
- **Ответ 200**: обновлённый объект книги.
- **Ошибки**:
  - `404` — книга не найдена.
  - `401/403` — нет прав.

### POST `/books/import/by-isbn`

- **Описание**: импорт книги по ISBN из внешнего API (Open Library / Google Books).
- **Заголовки**:
  - `Authorization: Bearer <admin-JWT>`
- **Параметры query**:
  - `isbn` — обязательный.
- **Ответ 201**: созданная книга.
- **Ошибки**:
  - `404` — книга не найдена во внешнем API.
  - `502` — ошибка внешнего API.

### GET `/health`

- Аналогично другим сервисам.

---

## Order-service (порт 8003)

### POST `/cart/items`

- **Описание**: добавить или увеличить количество книги в корзине текущего пользователя.
- **Заголовки**:
  - `Authorization: Bearer <user-JWT>`
- **Тело запроса**:
  ```json
  {
    "book_id": 1,
    "qty": 2
  }
  ```
- **Ответ 201**:
  ```json
  {
    "items": [
      { "book_id": 1, "quantity": 2 },
      { "book_id": 5, "quantity": 1 }
    ]
  }
  ```
- **Ошибки**:
  - `400` — неверные данные (qty < 1 и т.п.).
  - `401` — нет JWT.

### GET `/cart`

- **Описание**: получить текущую корзину.
- **Ответ 200**:
  ```json
  {
    "items": [
      { "book_id": 1, "quantity": 2 }
    ]
  }
  ```

### POST `/orders`

- **Описание**: создать заказ из корзины.
- **Поведение**:
  - читает корзину,
  - дергает `catalog-service` по каждому `book_id` для получения цен,
  - создаёт `Order` и `OrderItems` в order_db,
  - очищает корзину,
  - публикует события `order.created` и `stock.reserve.request` в RabbitMQ,
  - асинхронно ожидает событий `stock.reserve.succeeded/failed` (по дизайну) и обновляет статус заказа.
- **Ответ 201**:
  ```json
  {
    "id": 10,
    "status": "created",
    "total_amount": 31.5,
    "created_at": "2025-01-01T12:00:00Z",
    "items": [
      { "book_id": 1, "quantity": 2, "price": 10.5 },
      { "book_id": 5, "quantity": 1, "price": 10.5 }
    ]
  }
  ```
- **Ошибки**:
  - `400` — корзина пуста.
  - `401` — нет JWT.

### GET `/orders`

- **Описание**: список заказов текущего пользователя.
- **Ответ 200**:
  ```json
  {
    "items": [
      {
        "id": 10,
        "status": "created",
        "total_amount": 31.5,
        "created_at": "2025-01-01T12:00:00Z",
        "items": [ ... ]
      }
    ]
  }
  ```

### GET `/orders/{id}`

- **Описание**: получить заказ по идентификатору пользователя (если он его владелец).
- **Ошибки**:
  - `404` — заказ не найден или не принадлежит пользователю.

### GET `/health`

- Аналогично.

---

## Analytics-service (порт 8004)

### GET `/events`

- **Описание**: получить последние N событий, обработанных сервисом аналитики.
- **Параметры query**:
  - `limit` (по умолчанию 50).
- **Ответ 200**:
  ```json
  {
    "items": [
      {
        "id": 1,
        "routing_key": "order.created",
        "idempotency_key": "uuid-...",
        "occurred_at": "2025-01-01T12:00:00Z",
        "payload": { "...": "..." }
      }
    ]
  }
  ```

### GET `/health`

- Аналогично другим сервисам.


