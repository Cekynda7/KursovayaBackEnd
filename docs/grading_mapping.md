## Grading mapping: соответствие требований и реализации

Ниже — таблица вида «требование → где реализовано → как проверить на защите».

| Требование из задания | Где реализовано (папка/файл/endpoint) | Как проверить (шаг/команда) |
|-----------------------|----------------------------------------|-----------------------------|
| Микросервисная архитектура, минимум 3 сервиса | `services/auth_service`, `services/catalog_service`, `services/order_service`, `services/analytics_service`; `docker-compose.yml` | Открыть структуру `services/` и `docker-compose.yml`, показать сервисы и их образы/порты |
| Отдельные БД (минимум одна SQL, PostgreSQL) | `docker/postgres/init.sql` (создание `auth_db`, `catalog_db`, `order_db`, `analytics_db`), Alembic миграции в `services/*/alembic/versions/0001_init.py` | Войти в Postgres или показать init.sql, подтвердить наличие 4 БД; опционально `docker compose exec postgres psql -l` |
| Auth-service: регистрация, логин, /me | `auth_service/src/auth_service/api/routes_auth.py` (`POST /auth/register`, `POST /auth/login`, `GET /auth/me`) | Через Swagger или curl: выполнить регистрацию, логин, запрос `/auth/me` |
| Auth-service: хранение паролей в защищённом виде (bcrypt/argon2) | `auth_service/src/auth_service/security.py` (`hash_password`, `verify_password` с `passlib[bcrypt]`); таблица `users.password_hash` | Показать код `hash_password`; в БД — поле `password_hash`, нет открытого пароля |
| JWT авторизация, роли user/admin | `auth_service/src/auth_service/security.py` (создание JWT); `auth_service/src/auth_service/models.py` (`UserRole`), `dependencies.py` (`get_current_user`, `get_current_admin`) | Логиниться, получить токен; попробовать вызвать `POST /books` для обычного юзера (403) и для admin (201) |
| Catalog-service: каталог книг, поиск/фильтр | `catalog_service/src/catalog_service/api/routes_books.py` (`GET /books`, `GET /books/{id}`) | `GET $CATALOG_URL/books?query=...&author=...&category=...` — получить список с фильтрацией |
| Catalog-service: CRUD книг (admin) | `routes_books.py` (`POST /books`, `PATCH /books/{id}`) с зависимостью `get_current_admin` | Под admin‑токеном создать книгу `POST /books`, затем изменить `PATCH /books/{id}` |
| Catalog-service: импорт по ISBN из внешнего API | `routes_books.py` (`POST /books/import/by-isbn`), `config.py` (`external_books_api_base`), использование `httpx` | Вызвать `POST /books/import/by-isbn?isbn=<ISBN>` под admin‑токеном, показать, что книга появилась в `GET /books` |
| Order-service: корзина/заказы | `order_service/src/order_service/api/routes_cart.py` (`POST /cart/items`, `GET /cart`), `routes_orders.py` (`POST /orders`, `GET /orders`, `GET /orders/{id}`) | Через curl: добавить книгу в корзину, посмотреть корзину, создать заказ, показать список заказов |
| Асинхронное взаимодействие через RabbitMQ | `order_service/src/order_service/message_bus.py` (publish), `catalog_service/src/catalog_service/message_bus.py` (consume/publish), `analytics_service/src/analytics_service/message_bus.py` (consume) | Создать заказ → в RabbitMQ UI показать exchange `bookstore.events` и события `order.created`, `stock.reserve.*`; `GET /events` в analytics показывает те же события |
| События RabbitMQ: order.created, stock.reserve.request, stock.reserve.succeeded, stock.reserve.failed | Контракты в `docs/event_contracts.md`; реализация в `order_service/message_bus.py` и `catalog_service/message_bus.py`, `analytics_service/message_bus.py` | Создать заказ с разными количествами товара, показать, что появляются оба типа событий (succeeded/failed) и отражаются в `/events` |
| Order-service: публикация OrderCreated и резервирование стока | `routes_orders.py` (после создания заказа вызывает `publish_event("order.created" ...)` и `publish_event("stock.reserve.request" ...)`), `message_bus.py` | В логах order-service показать события публикации, в RabbitMQ — события с соответствующими routing keys |
| Analytics-service: подписчик на события | `analytics_service/message_bus.py` (`AnalyticsConsumer`, `ensure_consumer_started` в `main.py`), таблица `events` | После создания заказа — `GET $ANALYTICS_URL/events`, убедиться, что там есть события по `routing_key` |
| Единый формат ошибок | `*/core/errors.py` в каждом сервисе, модель `ErrorResponse` в `schemas.py` | Вызвать эндпоинт с ошибкой (например, `qty=-1`) и показать JSON `{ "error_code", "message", "details" }` |
| Отсутствие 500 для любых входных данных | `core/errors.py` — глобальный `exception_handler(Exception)` возвращает `503 Service Unavailable` в едином формате, валидация через Pydantic схемы | Передать невалидные данные в POST (например, отрицательный qty, пустой email) → получить 4xx (422/400) с валидным JSON; при имитации внутренних ошибок — 503 с JSON, а не «голый» 500 |
| Валидация входа через Pydantic | `*/schemas.py` — все payload/DTO реализованы как Pydantic‑модели (Pydantic v2) | Посмотреть схемы в Swagger `/docs`: типы полей, ограничения (min_length, ge и т.п.) |
| ORM + Alembic миграции | SQLAlchemy модели в `*/models.py`, `db.py` (async engine), Alembic `env.py` и `versions/0001_init.py` в каждом сервисе | Показать структуры таблиц (ER‑диаграммы или миграции), убедиться, что таблицы создаются и используются ORM |
| Swagger/OpenAPI у каждого сервиса | Автоматически генерируется FastAPI‑приложениями `auth_service/main.py`, `catalog_service/main.py`, `order_service/main.py`, `analytics_service/main.py` | Открыть `/docs` и `/openapi.json` на портах 8001–8004 |
| Логирование и Correlation-Id | `*/core/logging.py` (structlog), `*/core/middleware.py` (`CorrelationIdMiddleware`), использование `X-Correlation-Id` | Выполнить запрос с заголовком `X-Correlation-Id: TEST-ID`, затем `docker compose logs <service>` и показать, что в логах присутствует `correlation_id="TEST-ID"` |
| Набор внешних API (импорт по ISBN) | `catalog_service/routes_books.py` (`/books/import/by-isbn`), `httpx.AsyncClient` к `external_books_api_base` | Вызвать импорт по ISBN, показать HTTP‑код и данные, дополнительно продемонстрировать созданную запись в каталоге |
| Документация в /docs | `docs/README_DOCS.md`, `diagrams/*.puml`, `api_contracts.md`, `business_requirements.md`, `event_contracts.md`, `threat_model.md`, `runbook.md`, `defense_guide.md` | Открыть папку `/docs` в IDE или на GitHub, показать наличие всех файлов и кратко пояснить их назначение |
| Базовые автотесты (pytest) | `services/auth_service/tests/test_auth_basic.py`, `services/catalog_service/tests/test_catalog_basic.py`, `services/order_service/tests/test_order_basic.py`, `services/analytics_service/tests/test_analytics_basic.py` | Локально запустить тесты (при наличии настроенного окружения) или показать содержимое файлов с тестами |




