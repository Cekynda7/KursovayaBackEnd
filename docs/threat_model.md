## Упрощённая модель угроз

Проект представляет собой публичный HTTP API для онлайн‑магазина книг с аутентификацией и несколькими микросервисами. Ниже перечислены основные угрозы и меры защиты.

### 1. Компрометация паролей пользователей

- **Угроза**: хранение паролей в открытом виде или слабыми алгоритмами позволяет злоумышленнику получить доступ ко всем аккаунтам при утечке БД.
- **Меры**:
  - Пароли **не хранятся** в открытом виде — только bcrypt‑хэши (`passlib[bcrypt]`).
  - Возможность задать требования к сложности пароля (минимальная длина, проверка на стороне клиента/сервера).

### 2. Перехват или подделка JWT‑токенов

- **Угроза**: похищенный JWT даёт полный доступ от лица пользователя до истечения срока действия.
- **Меры**:
  - Краткоживущие access‑токены (параметр `ACCESS_TOKEN_EXPIRE_MINUTES`).
  - Подпись JWT надёжным секретом `JWT_SECRET` и алгоритмом `HS256`.
  - Хранение секрета только в переменных окружения/`.env`, отсутствие в репозитории.
  - Возможность отзыва сессий через механизмы refresh‑токенов и списков отозванных токенов (таблица `refresh_tokens`).

### 3. Эскалация привилегий и обход ролей

- **Угроза**: пользователь с ролью `user` пытается выполнить действия администратора (CRUD книг).
- **Меры**:
  - Явная проверка роли (`user/admin`) в зависимостях FastAPI (`get_current_admin`).
  - Все эндпоинты, требующие роль admin (например, `POST /books`, `PATCH /books/{id}`, импорт по ISBN) закрыты JWT и проверкой роли.

### 4. SQL‑инъекции и некорректный доступ к БД

- **Угроза**: внедрение произвольных SQL‑команд через параметры запросов.
- **Меры**:
  - Использование SQLAlchemy ORM и параметризованных запросов.
  - Отсутствие конкатенации пользовательского ввода в SQL‑строки.
  - Явные схемы БД и миграции Alembic, минимизация прямого доступа к БД.

### 5. Валидация входных данных и DoS

- **Угроза**: передача больших или некорректных payload‑ов, вызывающих ошибки 500 или повышенную нагрузку.
- **Меры**:
  - Валидация всех входных данных через Pydantic‑модели (типизация, длины, диапазоны).
  - Глобальные обработчики исключений:
    - ошибки валидации → `422` с понятным описанием;
    - любые непойманные исключения → `503`, а не 500.
  - Возможность добавить rate‑limiting на уровне API‑шлюза или прокси (Nginx, API Gateway) — это рекомендованная мера расширения.

### 6. Логирование чувствительных данных

- **Угроза**: утечка секретов (пароли, токены) через логи.
- **Меры**:
  - Логируются только технические и бизнес‑события (id пользователей, id заказов), но не пароли.
  - `correlation_id` используется для трассировки запросов без раскрытия персональных данных.

### 7. Целостность и идемпотентность событий

- **Угроза**: повторная доставка сообщений RabbitMQ (at‑least‑once) может привести к двойному резервированию стока или дублированию заказов.
- **Меры**:
  - Каждое событие содержит `idempotency_key` и `event_id`.
  - Сервис аналитики сохраняет события вместе с `idempotency_key`, что позволяет отслеживать повторы.
  - По проектному замыслу `order-service` и `catalog-service` могут использовать `idempotency_key` для защиты от повторной обработки (например, через отдельные таблицы/уникальные ключи).

### 8. Общее

- **Передача данных по сети**: для production предполагается использование HTTPS‑терминации на уровне реверс‑прокси (Nginx / Cloud Load Balancer).
- **Разделение сервисов и БД**:
  - Для каждого микросервиса — своя схема/БД в PostgreSQL.
  - Минимизация прав: сервис работает только со своей БД.


